---
title: "Suits Index"
author: "Andie Creel"
date: 'September, 2022'
output: 
  html_document:
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE, message=FALSE}
rm(list = ls())
library(vroom)
library(tidyr)
library(stringr)
library(ggplot2)
library(gtools)
library(forcats)
options(scipen=99999)
library(janitor)
library(dplyr)
library(zoo)
library(runner)
source('09.functions.R')

# ----maps ---- #
library(choroplethr)
library(choroplethrMaps)
library(usdata)
library(maps)
library(tidycensus)
data("fips_codes")
data("state.regions")
library(RColorBrewer)


```

Thanks to Matt Ashenfarb for providing helpful code on the suites index. 
```{r, include=FALSE, message=FALSE}
#-------------------------------------------------------------------------------
# Basic data cleaning
# Grant amounts are already adjusted for inflation, adjusting median income (2018 dollars)
#-------------------------------------------------------------------------------

# made in 01.data_wrangle.R
myWorking <- vroom("Datasets/clean_data/lwcf_annualPop_deccenialDemographics.csv") 

#Basic data cleaning
myWorking <- myWorking %>%
  mutate(type = str_sub(type,0,1)) %>% #getting rid of a space 
  mutate(state_fips = as.factor(str_sub(fips, 1, 2))) %>% # getting state fips code
  filter(!is.na(white_pct)) %>% # getting rid of rows where I couldn't get their demographic data
  dplyr::mutate(poc_pct = 100 - white_pct) %>% # calculating % people of color as non-hispanic white
  mutate(amount = if_else(is.na(amount), 0, amount)) %>%  # adding 0s for amount of grant rewarded
  filter(type != "P") # not including planning grants bc they're given to states, not counties

# working years: 1965-2018
myWorking %>%
  select(real_year) %>%
  distinct() %>%
  summary()

```

# Set Up and Definitions 

The **outcomes of interest** is how the amount of LWCF funds and quantity of grants are distributed across demographic characteristics of interest. 

**Median household income** for a county is the demographic characteristic focused on in this write up. I use the average median household income (averaged from 1965-2018 for each county). 

Originally I used two different per capita measurements for the amount of LWCF funds and quantity of grantsL

1. Funds (or quantity of grants) given to a county  divided by the population of the county at the time of LWCF distribution. This captures how the program was administered through time.
2. The cumulative amount of funds (or quantity of grants) given to a county from 1965-2018 divided by the population of the county in 2020 (estimates for population of each county is not available for each county in 2018 in the American Community Survey). This captures how individuals today are effected by the LWCF program.

After both per capita metrics returned similar results (stored in commit from Sept 20th, 2022), I used the first definition which can be interpreted as how the program has been administered historically. 

I use per capita metrics for amount of funding and quantity of grants to control for a county's population. 

## Variable of Interest (X)
We are interested in the distribution of funds across the county-level demographic characteristics: median income, % POC, % rural. 

## Comparing of Suits Index across states 
We can compare the level of "regressivity" or "progressivity" (i.e., suits index) across states. For example, we could say Michigan is more progressive with its LWCF funds than Texas in regards to income. 

However, two states with different income distributions could have the same suits index. For example, Michigan and New Mexico may have different wealth distributions (ie Michigan is on average richer than New Mexico) but have the same suits index.  

```{r, echo=FALSE}
# Need to get two different per capital award amounts: per cap on nearest year to award amount (how it's been distributed historically) and per cap on most recent year (snap shot on how current people have been invested in)

#Steps: 
#1) Set up the two different per caps 
#1.5) Set up median income on X axis instead of % race (maybe write function where we can say variable on X, and give it the dataset (ex, just MTs dataset) so that this can be neater and quicker)
#2) National Suits for each (line graph)
#3) Suits for each state (choropleth)


#-------------------------------------------------------------------------------
#per cap: per current population aka snapshot of how people today are affect 
#-------------------------------------------------------------------------------

myWorking_per_cap_1 <- myWorking %>%
    mutate(amount_per_cap = amount / population) %>% # amount per capita each year
    mutate(quantity_per_cap = got_grant/ population) %>% #  quantity per capita each year
    group_by(fips) %>% # group by county
    mutate(amount_per_cap_cum = sum(amount_per_cap)) %>% # cumulative amount per cap
    mutate(quantity_per_cap_cum = sum(quantity_per_cap)) %>% # cumulative quantity per cap
    mutate(avg_med_income_house = mean(med_income_house, na.rm = TRUE)) %>% #average median income
    mutate(avg_poc_pct = mean(poc_pct, na.rm = TRUE)) %>%
    select(state_fips, fips, amount_cum, quantity_cum, avg_med_income_house, avg_poc_pct, poc_population) %>% # set up reduce down to one entry per county
    distinct() # reduce

```

# Income 
We treat each county as a rep agent of their population with their average median income. Makes sense to be per cap here. 

##Nation Picture

```{r, echo=FALSE, message=FALSE}

#-------------------------------------------------------------------------------
# results for nation 
#-------------------------------------------------------------------------------

myResult <- getSuits(myWorking_per_cap, x_axis = "POC")
printSuits(myResult, x_axis = "POC")
```


## State by State Picture

```{r, echo=FALSE, message=FALSE}
#-------------------------------------------------------------------------------
# results for states
# DATA PREP
#-------------------------------------------------------------------------------

fips_codes <- fips_codes %>%
  select(state_code) %>%
  distinct()

#Gets list of dataframes for each state (applys function to whole list of state fips)
state_dfs <- lapply(as.character(fips_codes$state_code), function(st=x){
                      df <- myWorking_per_cap  %>%
                        filter(state_fips == st) %>%
                        mutate(state_fips = as.character(state_fips))
                      return(df)
                      }) 


#get a data frame of suits results using function written earlier and list of state dataframes
myResult_state <- data.frame(matrix(ncol=3, nrow = length(state_dfs)))
colnames(myResult_state) <- c("state_fips", "Suits_Amount", "Suits_Quantity" )
for (i in 1:length(state_dfs)) {
  myResult_state[i, 1] <- state_dfs[[i]][1,1] #state fips
   myResult_state[i, 2] <- getSuits_inc(state_dfs[[i]])$Suits_Amount
     myResult_state[i, 3] <- getSuits_inc(state_dfs[[i]])$Suits_Quantity

}

# drop clean up state_fips codes
myResult_state <- myResult_state %>%
  mutate(state_fips = str_pad(state_fips, width = 2, pad ="0")) %>%
  mutate(state_fips = as.character(state_fips))

```


### Amount of Funds 
**The more negative a state, the more progressive of a policy.**

```{r, echo=FALSE}
#-------------------------------------------------------------------------------
# Make choropleth map of state results for suits index for amount of funding
#-------------------------------------------------------------------------------

# state_choropleth doesn't work for all fips codes, so we need to only use those in data(state.regions)
myMap_amount <- left_join(state.regions, myResult_state, by = c("fips.character" = "state_fips")) %>%
  mutate(value = Suits_Amount) %>% #for state_choropleth map call
  mutate(value = if_else(is.na(value), 0, value)) %>% #so that we don't have NAs in map
  filter()

#rewrote the state_choropleth function a bit to get rid of state label
myState_choropleth(myMap_amount, num_colors = 0, legend = "Suits Index" ) +  #num_colors = 0 makes it so white is zero
  ggtitle(label = "Suits indexes varries state to state despite being progessive nationally",
          subtitle =  "Amount of funding per capita compared to avg. median household income (aggregated at county level)") +
  theme(legend.position="bottom")



```

### Quantity of Grants

```{r, echo=FALSE}
#-------------------------------------------------------------------------------
# Make choropleth map of state results for suits index for quantity of grants
# same code as above with my revisous 
#-------------------------------------------------------------------------------

myMap_quantity <- left_join(state.regions, myResult_state, by = c("fips.character" = "state_fips")) %>%
  mutate(value = Suits_Quantity) %>% #REVISION
  mutate(value = if_else(is.na(value), 0, value)) %>% 
  filter()

myState_choropleth(myMap_quantity, num_colors = 0, legend = "Suits Index" ) +  
  ggtitle(label = "Suits indexes for quantity of grants is progessive in most states",
          subtitle =  "Quantity of grants per capita compared to avg. median household income (aggregated at county level)") +
  theme(legend.position="bottom") 

```

# Population of Color


```{r, echo=FALSE}

#Steps: 
#1) Need cumulative proportion of people of color currently (to be consistent with this defn of per capita)
#1.5) Set up cumulative prop of POC 
#2) National Suits for each (line graph)
#3) Suits for each state (choropleth)


#-------------------------------------------------------------------------------
#per cap: per current population aka snapshot of how people today are affect 
#-------------------------------------------------------------------------------

myResult_poc <- getSuits_poc(myWorking) #ATTN need to get this down to fewer 
printSuits(myResult_poc, x_axis = "POC")



```

## National Picture 







# Conclusions 
* LWCF seems pretty progressive with regards to income 


