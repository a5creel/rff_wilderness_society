---
title: "Suits Index"
author: "Andie Creel"
date: '2022-06-29'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE, message=FALSE}
library(vroom)
library(tidyr)
library(stringr)
library(ggplot2)
library(gtools)
library(forcats)
options(scipen=99999)
library(janitor)
library(dplyr)
library(zoo)
library(runner)
```

Thanks to Matt Ashenfarb for providing helpful code on the suites index. 
```{r, include=FALSE, message=FALSE}
# made in 01.data_wrangle.R
myWorking <- vroom("Datasets/clean_data/lwcf_annualPop_deccenialDemographics.csv") 

# Grant amounts are already adjusted for inflation, adjusting median income (2018 dollars)

#Basic data cleaning
myWorking <- myWorking %>%
  mutate(type = str_sub(type,0,1)) %>% #getting rid of a space 
  mutate(state_fips = as.factor(str_sub(fips, 1, 2))) %>% # getting state fips code
  filter(!is.na(white_pct)) %>% # getting ride of rows where I couldn't get their demographic data
  dplyr::mutate(poc_pct = 100 - white_pct) %>% # calculating % people of color as non-hispanic white
  mutate(amount = if_else(is.na(amount), 0, amount)) %>%  # adding 0s for amount of grant rewarded
  filter(type != "P") # not including planning grants bc they're given to states, not counties

# working years: 1965-2018
myWorking %>%
  select(real_year) %>%
  distinct() %>%
  summary()

# ALL GRANTS (except planning): ALL YEARS -----------------------------------------------------------------------
```



```{r, include=FALSE}
# Grouping outcome variables by county, cumulative through all time 
#(number of grants received, amount received, average amount received per capita per decade, avg # grants per 100,000 people)

#cumulative through all years
myWorking_cum <- myWorking %>%
    filter(type != "P") %>% # not including planning grants bc they're given to states, not counties
    group_by(fips) %>% # grouping by county
    mutate(quantity = sum(got_grant)) %>% #grants through all time
    mutate(amount = sum(amount, na.rm = TRUE)) %>% # amount through all time
    mutate(avg_white_ppl= mean(white)) %>% 
    select(fips, state_fips, quantity, quantity, amount, avg_white_ppl) %>%
    ungroup() %>%
    distinct()

```

# Original Set Up
Originally, my explanatory variable of interest is the average percent (through 1965-2018) of non-Hispanic white people in each county. The % of the county that is white comes from the decennial census and the 2018 America community survey.  

My outcome variable of interest was originally the total amount of funding and the total amount of grants a county gets as a percentage of average % white, **but that doesn't account for population in a county. **

## Suites Index Calculation 
```{r}
# suits index: code from Matt Ashenfarb ---------------

#step one: get proportion of all white people & prop of all LWCF funding (amount) & prop of all LWCF grants (quantity)
myWorking_cum$white_prop <- myWorking_cum$avg_white_ppl/sum(myWorking_cum$avg_white_ppl)
myWorking_cum$quantity_prop <- myWorking_cum$quantity/sum(myWorking_cum$quantity)
myWorking_cum$amount_prop <- myWorking_cum$amount/sum(myWorking_cum$amount)

#step two: sort based on prop of white people (ascending)
myWorking_cum <- arrange(myWorking_cum, white_prop)

#step three: get cumulative distributions 
white_cumsum <- sum_run(myWorking_cum$white_prop)
quantity_cumsum <- sum_run(myWorking_cum$quantity_prop)
amount_cumsum <- sum_run(myWorking_cum$amount_prop)

# Step four: use trapezoid rule to get area under curve 
area_L_quantity <- sum(diff(white_cumsum)*rollmean(quantity_cumsum, 2)) ##diff is trap hight and rollmean is (b1+b2)/2
area_L_amount <- sum(diff(white_cumsum)*rollmean(amount_cumsum, 2)) ##diff is trap hight and rollmean is (b1+b2)/2
area_K <- .5 # triangle [(0,0), (0,1), (1,1)]

# Step five: calculate suits index 
suits_index_amount <- (area_K - area_L_amount)/area_K
suits_index_quantity <- (area_K - area_L_quantity)/area_K

print(paste('Suits index for amount of funding and white:', suits_index_amount))
print(paste('Suits index for quantity of grants and white:', suits_index_quantity))


myGraphData <- data.frame(white_cumsum, quantity_cumsum, amount_cumsum, myWorking_cum$white_prop)

# Step 6: try to graph
ggplot(myGraphData, aes(x=white_cumsum, y=quantity_cumsum)) + 
  geom_point() +
  ggtitle("Amount", subtitle = "Each point is for a county") +
  xlab("Cumulative proportion of average % white") + 
  ylab("Cumulative proportions quantity of grants") +
  theme_bw()

ggplot(myGraphData, aes(x=white_cumsum, y=amount_cumsum)) + 
  geom_point() +
  ggtitle("Quantity", subtitle = "Each point is for a county") +
  xlab("Cumulative proportion of average % white") + 
  ylab("Cumulative proportions of funding") +
  theme_bw()


```


## Quick Interprutation 
Currently, each suits index is showing that the the LWCF policy is *progressive* with respect to people of color. However, I haven't accounted for how average % white may be correlated with population. 



<!-- # Ex-Confederate States -->
<!-- Code isn't done yet. -->
```{r, include= FALSE}
myWorking_cum_south <- myWorking %>%
    filter(type != "P") %>% # not including planning grants bc they're given to states, not counties
    group_by(fips) %>%
    mutate(quantity = sum(got_grant)) %>% #grants through all time
    mutate(amount = sum(amount, na.rm = TRUE)) %>% # amoutn through all time
    mutate(avg_white_ppl= mean(white)) %>%
    select(fips, state_fips, quantity, quantity, amount, avg_white_ppl) %>%
    ungroup() %>%
    distinct() %>%
    filter(state_fips =='48' | state_fips =='05'| state_fips == '22' | state_fips == '47' | state_fips =='28' | state_fips == '01' | state_fips == '13' | state_fips == '12' | state_fips == '45' | state_fips == '37' | state_fips == '51')
    # confederacy: Texas, Arkansas, Louisiana, Tennessee, Mississippi, Alabama, Georgia, Florida, South Carolina, North Carolina and Virginia

```
