---
title: "Suits Index"
author: "Andie Creel"
date: '2022-06-29'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE, message=FALSE}
library(vroom)
library(tidyr)
library(stringr)
library(ggplot2)
library(gtools)
library(forcats)
options(scipen=99999)
library(janitor)
library(dplyr)
library(zoo)
library(runner)
```

Thanks to Matt Ashenfarb for providing helpful code on the suites index. 
```{r, include=FALSE, message=FALSE}
# made in 01.data_wrangle.R
myWorking <- vroom("Datasets/clean_data/lwcf_annualPop_deccenialDemographics.csv") 

# Grant amounts are already adjusted for inflation, adjusting median income (2018 dollars)

#Basic data cleaning
myWorking <- myWorking %>%
  mutate(type = str_sub(type,0,1)) %>% #getting rid of a space 
  mutate(state_fips = as.factor(str_sub(fips, 1, 2))) %>% # getting state fips code
  filter(!is.na(white_pct)) %>% # getting ride of rows where I couldn't get their demographic data
  dplyr::mutate(poc_pct = 100 - white_pct) %>% # calculating % people of color as non-hispanic white
  mutate(amount = if_else(is.na(amount), 0, amount)) %>%  # adding 0s for amount of grant rewarded
  filter(type != "P") # not including planning grants bc they're given to states, not counties

# working years: 1965-2018
myWorking %>%
  select(real_year) %>%
  distinct() %>%
  summary()

# ALL GRANTS (except planning): ALL YEARS -----------------------------------------------------------------------
```



```{r, include=FALSE}
# Grouping outcome variables by county, cumulative through all time 
#(number of grants received, amount received, average amount received per capita per decade, avg # grants per 100,000 people)

#cumulative through all years
myWorking_cum <- myWorking %>%
    filter(type != "P") %>% # not including planning grants bc they're given to states, not counties
    group_by(fips) %>% # grouping by county
    mutate(quantity = sum(got_grant)) %>% #grants through all time
    mutate(amount = sum(amount, na.rm = TRUE)) %>% # amount through all time
    mutate(avg_white_ppl= mean(white)) %>% 
    select(fips, state_fips, quantity, quantity, amount, avg_white_ppl) %>%
    ungroup() %>%
    distinct()

# Need to get two different per capital award amounts: per cap on nearest year to award amount (how it's been distributed historically) and per cap on most recent year (snap shot on how current people have been invested in)

#Steps: 
#1) Set up the two different per caps 
#1.5) Set up median income on X axis instead of % race (maybe write function where we can say variable on X, and give it the dataset (ex, just MTs dataset) so that this can be neater and quicker)
#2) National Suits for each (line graph)
#3) Suits for each state (choropleth)

# First per cap: per cap through time aka how it's been implemented through time 
myWorking_per_cap_1 <- myWorking %>%
    filter(type != "P") %>% # not including planning grants bc they're given to states, not counties
    mutate(amount_per_cap = amount / population) %>% # amount per capita each year
    mutate(quantity_per_cap = got_grant/ population) %>% #  quantity per capita each year
    group_by(fips) %>% # group by county
    mutate(amount_per_cap_cum = sum(amount_per_cap)) %>% # cumulative amount per cap
    mutate(quantity_per_cap_cum = sum(quantity_per_cap)) %>% # cumulative quantity per cap
    mutate(avg_med_income_house = mean(med_income_house, na.rm = TRUE)) %>% #average median income
    select(state_fips, fips, amount_per_cap_cum, quantity_per_cap_cum, avg_med_income_house) %>% # set up reduce down to one entry per county
    distinct() # reduce

#Second per cap: per current population aka snapshot of how people today are affect 

# Get latest year's population (2018)
myLatest_pop <- myWorking %>%
  filter(year >= 2018)?
  
myLatest_pop <- read.csv("Datasets/raw_data/nhgis0011_csv/nhgis0011_ds238_2018_county.csv")
myLatest_pop <- myLatest_pop[-1,]
myLatest_pop <- myLatest_pop %>%
  mutate(fips = paste0(STATEA, COUNTYA)) %>%
  select(fips, AIUWE001) %>%
  rename(population_18 = AIUWE001) %>%
  mutate(population_18 = as.integer(population_18))

myWorking_per_cap_2 <- myWorking %>%
    filter(type != "P") %>% # not including planning grants bc they're given to states, not counties
    group_by(fips) %>% # group by county
    mutate(amount_cum = sum(amount)) %>% # cumulative amount per cap
    mutate(quantity_cum = sum(got_grant)) %>% # cumulative quantity per cap
    mutate(avg_med_income_house = mean(med_income_house, na.rm = TRUE)) %>% #average median income
    select(state_fips, fips, amount_cum, quantity_cum, avg_med_income_house) %>% # set up reduce down to one entry per county
    distinct() # reduce

myWorking_per_cap_2 <- left_join(myWorking_per_cap_2, myLatest_pop, "fips")

#ATTENTION! WE DONT HAVE POPULATION FOR EVERY COUNTY. 
# may need to use 2020 or 2010 census?

```


# Add in defninitions of per caps 
* how it's been implemented through time
* snap shot of how individuals have been invested in presently 









# Original Set Up
Originally, my explanatory variable of interest is the average percent (through 1965-2018) of non-Hispanic white people in each county. The % of the county that is white comes from the decennial census and the 2018 America community survey.  

My outcome variable of interest was originally the total amount of funding and the total amount of grants a county gets as a percentage of average % white, **but that doesn't account for population in a county. **

## Suites Index Calculation 
```{r}
# suits index: code from Matt Ashenfarb ---------------

#step one: get proportion of all white people & prop of all LWCF funding (amount) & prop of all LWCF grants (quantity)
myWorking_cum$white_prop <- myWorking_cum$avg_white_ppl/sum(myWorking_cum$avg_white_ppl)
myWorking_cum$quantity_prop <- myWorking_cum$quantity/sum(myWorking_cum$quantity)
myWorking_cum$amount_prop <- myWorking_cum$amount/sum(myWorking_cum$amount)

#step two: sort based on prop of white people (ascending)
myWorking_cum <- arrange(myWorking_cum, white_prop)

#step three: get cumulative distributions 
white_cumsum <- sum_run(myWorking_cum$white_prop)
quantity_cumsum <- sum_run(myWorking_cum$quantity_prop)
amount_cumsum <- sum_run(myWorking_cum$amount_prop)

# Step four: use trapezoid rule to get area under curve 
area_L_quantity <- sum(diff(white_cumsum)*rollmean(quantity_cumsum, 2)) ##diff is trap hight and rollmean is (b1+b2)/2
area_L_amount <- sum(diff(white_cumsum)*rollmean(amount_cumsum, 2)) ##diff is trap hight and rollmean is (b1+b2)/2
area_K <- .5 # triangle [(0,0), (0,1), (1,1)]

# Step five: calculate suits index 
suits_index_amount <- (area_K - area_L_amount)/area_K
suits_index_quantity <- (area_K - area_L_quantity)/area_K

print(paste('Suits index for amount of funding and white:', suits_index_amount))
print(paste('Suits index for quantity of grants and white:', suits_index_quantity))


myGraphData <- data.frame(white_cumsum, quantity_cumsum, amount_cumsum, myWorking_cum$white_prop)

# Step 6: try to graph
ggplot(myGraphData, aes(x=white_cumsum, y=quantity_cumsum)) + 
  geom_point() +
  ggtitle("Amount", subtitle = "Each point is for a county") +
  xlab("Cumulative proportion of average % white") + 
  ylab("Cumulative proportions quantity of grants") +
  theme_bw()

ggplot(myGraphData, aes(x=white_cumsum, y=amount_cumsum)) + 
  geom_point() +
  ggtitle("Quantity", subtitle = "Each point is for a county") +
  xlab("Cumulative proportion of average % white") + 
  ylab("Cumulative proportions of funding") +
  theme_bw()


```


## Quick Interprutation 
Currently, each suits index is showing that the the LWCF policy is *progressive* with respect to people of color. However, I haven't accounted for how average % white may be correlated with population. 



<!-- # Ex-Confederate States -->
<!-- Code isn't done yet. -->
```{r, include= FALSE}
myWorking_cum_south <- myWorking %>%
    filter(type != "P") %>% # not including planning grants bc they're given to states, not counties
    group_by(fips) %>%
    mutate(quantity = sum(got_grant)) %>% #grants through all time
    mutate(amount = sum(amount, na.rm = TRUE)) %>% # amoutn through all time
    mutate(avg_white_ppl= mean(white)) %>%
    select(fips, state_fips, quantity, quantity, amount, avg_white_ppl) %>%
    ungroup() %>%
    distinct() %>%
    filter(state_fips =='48' | state_fips =='05'| state_fips == '22' | state_fips == '47' | state_fips =='28' | state_fips == '01' | state_fips == '13' | state_fips == '12' | state_fips == '45' | state_fips == '37' | state_fips == '51')
    # confederacy: Texas, Arkansas, Louisiana, Tennessee, Mississippi, Alabama, Georgia, Florida, South Carolina, North Carolina and Virginia

```
